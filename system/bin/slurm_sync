#!/bin/bash

# slurm_sync
# Matt Allbright
# Simple utility to sync slurm.conf files between nodes on the cluster. Required
# for smooth performance and communication between nodes.

echo -en '\n'
echo "Grabbing newest Slurm configuration files."
ssh root@$HOSTNAME rm -rf /etc/slurm-llnl/slurm.conf
ssh root@$HOSTNAME cp /opt/cloud/staging/etc/slurm/slurm.conf /etc/slurm-llnl/

echo "Synching slurm.conf files."
rsync -ar /etc/slurm-llnl/slurm.conf root@empire:/etc/slurm-llnl/
rsync -ar /etc/slurm-llnl/slurm.conf root@jedi:/etc/slurm-llnl/

/opt/cloud/staging/system/bin/slurm_reset

echo "Would you like to display log rotation?"

read -r -p "[y/N] " logrotate
if [[ "$logrotate" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        echo "Beginning log rotation."
        sleep 2
        /opt/cloud/staging/system/bin/slurm_rotate
else
        echo "Goodnight."
fi
